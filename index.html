<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro Digital de Dise√±o</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; }
        body { background: #f5f7fa; color: #333; }
        .container { max-width: 100%; margin: 0 auto; padding: 16px; }
        .header { text-align: center; margin-bottom: 20px; }
        .header h1 { font-size: 1.5rem; color: #10a37f; margin-bottom: 8px; }
        .header p { color: #666; font-size: 0.9rem; }
        
        .chat-container { background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); overflow: hidden; height: calc(100vh - 160px); display: flex; flex-direction: column; }
        .messages { flex: 1; overflow-y: auto; padding: 16px; }
        .row { display: flex; margin-bottom: 16px; }
        .user { flex-direction: row-reverse; }
        .avatar { width: 36px; height: 36px; border-radius: 50%; background: #10a37f; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; margin: 0 8px; flex-shrink: 0; }
        .user .avatar { background: #3b82f6; }
        .bubble { max-width: 75%; padding: 12px 16px; border-radius: 18px; background: #f0f2f5; line-height: 1.4; }
        .user .bubble { background: #3b82f6; color: white; }
        .bubble strong { font-weight: 600; }
        .bubble img { max-width: 100%; height: auto; border-radius: 8px; margin: 8px 0; }
        
        .input-area { padding: 16px; border-top: 1px solid #eaeaea; display: flex; align-items: center; background: white; }
        #input { flex: 1; border: 1px solid #e0e0e0; border-radius: 24px; padding: 12px 16px; resize: none; outline: none; max-height: 120px; }
        #send, #talk, #clear { background: #10a37f; color: white; border: none; border-radius: 50%; width: 44px; height: 44px; margin-left: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        #talk { background: #3b82f6; }
        #clear { background: #ef4444; }
        
        .chips { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
        .chip { background: white; border: 1px solid #e0e0e0; border-radius: 16px; padding: 8px 16px; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; }
        .chip:hover { background: #f0f2f5; }
        
        .typing { color: #666; font-size: 0.9rem; padding: 0 16px 16px; }
        
        @media (max-width: 480px) {
            .container { padding: 12px; }
            .chat-container { height: calc(100vh - 140px); }
            .bubble { max-width: 85%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Centro Digital de Dise√±o</h1>
            <p>Asistente virtual ¬∑ Dise√±o web ¬∑ Marketing ¬∑ Automatizaciones</p>
        </div>
        
        <div class="chat-container">
            <div id="messages" class="messages"></div>
            <div id="typing" class="typing"></div>
            
            <div class="input-area">
                <textarea id="input" placeholder="Escribe o dicta tu mensaje..." rows="1"></textarea>
                <button id="send">‚Üí</button>
                <button id="talk">üé§</button>
                <button id="clear">√ó</button>
            </div>
        </div>
    </div>

    <script>
// ================== bot.js (voz sin repeticiones - CORREGIDO) ==================
const msgs  = document.getElementById('messages');
const input = document.getElementById('input');
const send  = document.getElementById('send');
const typing= document.getElementById('typing');
const clear = document.getElementById('clear');
const talk  = document.getElementById('talk');

const STORAGE_KEY = 'cdd_chat_history_v1';
const FLOW_KEY    = 'cdd_quote_flow_state_v1';

// Contacto oficial
const OFICIAL_PHONE = "573202608864";
const OFICIAL_MAIL  = "centrodigitaldediseno@gmail.com";

const CTA = `\n\n¬øQuieres cotizar tu proyecto? ‚ú®<br>
Escribe <strong>cotizar</strong> o cont√°ctanos:<br>
üì≤ WhatsApp: +${OFICIAL_PHONE} ¬∑ ‚úâÔ∏è ${OFICIAL_MAIL}`;

// ===== Contenidos =====
const KB = {
  servicios:
`### Servicios principales
1. <strong>Dise√±o web moderno y optimizado</strong> (landing, multip√°gina, e-commerce).<br>
2. <strong>Branding & dise√±o de marca</strong> (logo, identidad, manual).<br>
3. <strong>Contenido visual</strong> (posts, reels, videos cortos).<br>
4. <strong>Marketing digital</strong> (campa√±as, funnels, Meta/Google/TikTok).<br>
5. <strong>Gesti√≥n de redes</strong> (SMM, crecimiento org√°nico).<br>
6. <strong>SEO</strong> (redes y web).<br>
7. <strong>Fotograf√≠a de producto</strong>.<br>
8. <strong>Automatizaciones con IA</strong>.<br>
9. <strong>Videos con IA</strong>.<br>
10. <strong>Im√°genes/AV con IA</strong>.<br>
11. <strong>Bots de mensajes y llamadas</strong>.<br>
12. <strong>Embudos de ventas automatizados</strong>.<br>
13. <strong>Realidad aumentada</strong>.<br>
14. <strong>Apps Premium</strong> (VPN, YouTube Premium, PhotoRoom‚Ä¶).<br>
15. <strong>Marketing con IA</strong> (predictivo, personalizaci√≥n).${CTA}`,

  web:
`### P√°ginas web (moderno + conversi√≥n)
- Dise√±o <strong>responsive</strong> (landing, multip√°gina, e-commerce).<br>
- <strong>SEO t√©cnico</strong> y Core Web Vitals.<br>
- Integraci√≥n con <strong>WhatsApp, CRM y anal√≠tica</strong>.<br>
- Optimizaci√≥n de <strong>copy</strong> y estructura para conversi√≥n.<br><br>

<strong>Portafolio ‚Äî Webs</strong><br>
üîó <a href="https://marketflix.com.co" target="_blank">Marketflix.com.co</a><br>
<img src="assets/marketflix.png" width="260" alt="Marketflix"><br>
Plataforma con autenticaci√≥n, base de datos, interactividad multimedia y env√≠os de correos (workflows).<br><br>

üîó <a href="https://centrodigitaldis.wixsite.com/volservice" target="_blank">Volservice</a><br>
<img src="assets/volservice.png" width="260" alt="Volservice"><br>
Tienda + blog para SEO org√°nico, correos e indexaci√≥n.<br><br>

üîó <a href="https://almaverde.com.co/" target="_blank">AlmaVerde.com.co</a><br>
<img src="assets/almaverde.png" width="260" alt="AlmaVerde"><br>
Portafolio comercial, proyectos, captaci√≥n de leads, correos, blog con art√≠culos para SEO e indexaci√≥n.<br><br>

üîó <a href="https://premiumappscol.wixsite.com/inicio" target="_blank">Premium Apps</a><br>
<img src="assets/premiumapps.png" width="260" alt="Premium Apps"><br>
Sitio de apps premium (en construcci√≥n), APKs gratuitas por tiempo limitado.${CTA}`,

  automat:
`### Automatizaciones & Bots
- <strong>ManyChat/WhatsApp</strong>: flujos, segmentaci√≥n, campa√±as.<br>
- <strong>Make</strong>: integra formularios, CRM, Google, Meta, Email.<br>
- <strong>Bots de IA</strong> entrenados con tus textos/FAQs.<br><br>

<strong>Ejemplo ‚Äî Bot ‚ÄúEmilia‚Äù (Servimil)</strong><br>
<img src="assets/emilia.png" width="260" alt="Bot Emilia" style="border-radius:12px"><br>
Asistente virtual que responde y gu√≠a clientes por WhatsApp.<br><br>

<a href="https://wa.me/573157019885?text=Hola%20Emilia,%20quiero%20informaci%C3%B3n" target="_blank"
style="display:inline-block;background:#10a37f;color:#fff;text-decoration:none;padding:8px 14px;border-radius:10px;font-weight:600">Probar bot en WhatsApp</a>${CTA}`,

  branding:
`### Branding & dise√±o de marca
- Identidad visual completa, manual de marca, kit para redes.${CTA}`,

  mktia:
`### Marketing con IA
- Segmentaci√≥n y creatividades con IA, anal√≠tica predictiva, personalizaci√≥n.${CTA}`,

  cotiz:
`### Cotizaci√≥n
Trabajamos <strong>por alcance y objetivos</strong> (p√°ginas, integraciones, contenido, automatizaciones).<br><br>
1) Brief r√°pido + llamada de 15‚Äì20 min.<br>
2) Propuesta con entregables, tiempos y valor.<br>
3) Arranque del Sprint 1.${CTA}`
};

// ===== Estado del flujo =====
let flow = loadFlowState() || {activo:false,paso:0,datos:{nombre:"",servicios:"",empresa:"",telefono:""}};

// ===== Inicio =====
if (!localStorage.getItem(STORAGE_KEY)) {
  botMsg("üëã <strong>Hola</strong>, soy el asistente del Centro Digital de Dise√±o. Puedo contarte de <strong>servicios</strong>, <strong>p√°ginas web</strong>, <strong>automatizaciones</strong> o ayudarte a <strong>cotizar</strong>.");
}

send.onclick = () => {
  const txt = input.value.trim();
  if (!txt) return;
  input.value = "";
  userMsg(txt);
  route(txt);
};

input.addEventListener("keydown", e=>{
  if (e.key==="Enter" && !e.shiftKey){ e.preventDefault(); send.click(); }
});

document.querySelectorAll(".chip").forEach(c=>{
  c.onclick = () => { userMsg(c.dataset.q); route(c.dataset.q); };
});

if (clear){
  clear.onclick = () => {
    localStorage.removeItem(STORAGE_KEY);
    localStorage.removeItem(FLOW_KEY);
    msgs.innerHTML = "";
    flow = {activo:false,paso:0,datos:{nombre:"",servicios:"",empresa:"",telefono:""}};
    botMsg("üßπ Historial limpio. Escribe <strong>cotizar</strong> para iniciar una nueva cotizaci√≥n.");
  };
}

// ===== Router =====
function route(q){
  const qn = norm(q);

  if (flow.activo) { handleCotizacion(q); return; }
  if (/cotiz/i.test(qn)) { startCotizacion(); return; }

  if (/^servicio(s)?$|que hacen|ofrecen|todo/i.test(qn)){
    botMsg(KB.servicios);
    botMsg(servicesButtonsHTML());
    return;
  }
  if (/web|tienda|landing|site/i.test(qn)) { botMsg(KB.web); return; }
  if (/automat|bot|ia|whatsapp|manychat|make/i.test(qn)) { botMsg(KB.automat); return; }
  if (/branding/i.test(qn)) { botMsg(KB.branding); return; }
  if (/marketing con ia|mkt ia|marketing ia/i.test(qn)) { botMsg(KB.mktia); return; }

  botMsg("Puedo contarte sobre <strong>servicios</strong>, <strong>p√°ginas web</strong>, <strong>automatizaciones</strong> o ayudarte a <strong>cotizar</strong>.");
}

// Chips dentro del mensaje de Servicios
function servicesButtonsHTML(){
  const style = "display:inline-block;margin:6px 8px 0 0;padding:8px 14px;border-radius:999px;border:1px solid #d0d7e2;text-decoration:none;color:inherit;background:#fff";
  return `
<div style="margin-top:6px">
  <a href="#" class="chip-link" data-q="P√°ginas web" style="${style}">üåê P√°ginas web</a>
  <a href="#" class="chip-link" data-q="Branding" style="${style}">üé® Branding</a>
  <a href="#" class="chip-link" data-q="Automatizaciones" style="${style}">‚öôÔ∏è Automatizaciones</a>
  <a href="#" class="chip-link" data-q="Marketing con IA" style="${style}">ü§ñ Marketing con IA</a>
</div>`;
}
document.addEventListener("click", (e)=>{
  const a = e.target.closest(".chip-link");
  if (!a) return;
  e.preventDefault();
  const q = a.dataset.q || a.textContent.trim();
  userMsg(q);
  route(q);
});

// ===== Flujo de Cotizaci√≥n =====
function startCotizacion(){
  flow = {activo:true, paso:1, datos:{nombre:"",servicios:"",empresa:"",telefono:""}};
  saveFlowState();
  botMsg("Perfecto üôå Para cotizar necesito unos datos.<br>1Ô∏è‚É£ ¬øCu√°l es tu <strong>nombre completo</strong>?");
}
function handleCotizacion(txt){
  switch (flow.paso){
    case 1:
      flow.datos.nombre = txt; flow.paso = 2; saveFlowState();
      botMsg("2Ô∏è‚É£ ¬øQu√© <strong>servicios</strong> te interesan?");
      break;
    case 2:
      flow.datos.servicios = txt; flow.paso = 3; saveFlowState();
      botMsg("3Ô∏è‚É£ ¬øNombre de tu <strong>empresa o proyecto</strong>?");
      break;
    case 3:
      flow.datos.empresa = txt; flow.paso = 4; saveFlowState();
      botMsg("4Ô∏è‚É£ Tu <strong>n√∫mero de WhatsApp</strong> (ej. 3001234567 o +57 3001234567)");
      break;
    case 4:
      flow.datos.telefono = txt;
      finalizeQuote();
      break;
  }
}
function finalizeQuote(){
  const {nombre,servicios,empresa,telefono} = flow.datos;
  const wapp = `https://wa.me/${OFICIAL_PHONE}?text=${encodeURIComponent(`Hola soy ${nombre} (${empresa}). Me interesa: ${servicios}. Mi contacto: ${telefono}`)}`;
  const mail = `mailto:${OFICIAL_MAIL}?subject=Cotizaci√≥n&body=${encodeURIComponent(`Nombre: ${nombre}\nServicios: ${servicios}\nEmpresa: ${empresa}\nTel√©fono: ${telefono}`)}`;

  botMsg(
`### ¬°Gracias ${escapeHTML(nombre)}!
Resumen de tu solicitud:
- <strong>Servicios:</strong> ${escapeHTML(servicios)}<br>
- <strong>Empresa:</strong> ${escapeHTML(empresa)}<br>
- <strong>Tel√©fono:</strong> ${escapeHTML(telefono)}<br><br>
üëâ Para continuar, <strong>presiona uno de los botones</strong>:<br>
<a href="${wapp}" target="_blank" style="display:inline-block;background:#10a37f;color:#fff;text-decoration:none;padding:8px 14px;border-radius:10px;font-weight:600;margin-right:8px">üì≤ WhatsApp</a>
<a href="${mail}" style="display:inline-block;background:#10a37f;color:#fff;text-decoration:none;padding:8px 14px;border-radius:10px;font-weight:600">‚úâÔ∏è Email</a>
${CTA}`
  );

  flow = {activo:false,paso:0,datos:{nombre:"",servicios:"",empresa:"",telefono:""}};
  saveFlowState();
}

// ===== Render =====
function render(role, html){
  const row = document.createElement("div");
  row.className = "row " + (role === "assistant" ? "assistant" : "user");

  const av = document.createElement("div");
  av.className = "avatar";
  av.textContent = role === "assistant" ? "AI" : "T√∫";

  const bub = document.createElement("div");
  bub.className = "bubble";
  bub.innerHTML = html;

  row.appendChild(av); row.appendChild(bub);
  msgs.appendChild(row);
  requestAnimationFrame(()=>{ msgs.scrollTop = msgs.scrollHeight; });
}
function userMsg(t){ render("user", escapeHTML(t)); }
function botMsg(t){ render("assistant", t); }

// ===== Utils =====
function escapeHTML(s){return (s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));}
function norm(s){ return (s||'').toLowerCase().trim(); }
function saveFlowState(){ localStorage.setItem(FLOW_KEY, JSON.stringify(flow)); }
function loadFlowState(){ try{ return JSON.parse(localStorage.getItem(FLOW_KEY)||"null"); } catch { return null; } }

// ============ VOZ ‚Äî anti-repeticiones (CORREGIDO) ============
// Estado del dictado
let recognition;
const vr = {
  running: false,
  committed: "",   // texto final confirmado
  lastInterim: "", // √∫ltimo interim mostrado para no repetir
  timer: null
};

// Une dos cadenas evitando duplicar la parte solapada
function overlapAppend(base, next){
  const b = (base||"").trim();
  const a = (next||"").trim();
  if (!b) return a;
  
  // Buscar la posici√≥n donde se solapan
  let overlapPos = -1;
  for (let i = 1; i <= Math.min(b.length, a.length); i++) {
    if (b.endsWith(a.substring(0, i))) {
      overlapPos = i;
    }
  }
  
  // Si hay solapamiento, concatenar sin duplicar
  if (overlapPos > 0) {
    return b + a.substring(overlapPos);
  }
  
  // Si no hay solapamiento, concatenar con espacio
  return (b + " " + a).replace(/\s+/g, ' ').trim();
}

function resetSilenceTimer(){
  clearTimeout(vr.timer);
  vr.timer = setTimeout(()=>{
    if (!vr.running) return;
    const toSend = (input.value || vr.committed || "").trim();
    if (toSend){
      try { recognition.stop(); } catch {}
      vr.running = false;
      talk.textContent = 'üé§';
      input.value = toSend;
      send.click();
    }
  }, 1500);
}

if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window){
  recognition = new (window.webkitSpeechRecognition || window.SpeechRecognition)();
  recognition.lang = "es-ES";
  recognition.continuous = true;
  recognition.interimResults = true;
  recognition.maxAlternatives = 1;

  recognition.onstart = () => {
    vr.running   = true;
    vr.committed = "";
    vr.lastInterim = "";
    input.value  = "";                // limpiamos la caja
    clearTimeout(vr.timer);
    talk.textContent = 'üî¥';
    botMsg("üé§ Estoy escuchando; cuando haya 1.5 s sin voz enviar√© tu mensaje autom√°ticamente.");
  };

  recognition.onresult = (e) => {
    let interimTranscript = '';
    let finalTranscript = '';
    
    for (let i = e.resultIndex; i < e.results.length; i++){
      const transcript = e.results[i][0].transcript;
      
      if (e.results[i].isFinal) {
        finalTranscript += transcript;
      } else {
        interimTranscript += transcript;
      }
    }
    
    // Procesar texto final
    if (finalTranscript) {
      vr.committed = overlapAppend(vr.committed, finalTranscript);
      input.value = vr.committed;
      vr.lastInterim = "";
    }
    
    // Procesar texto intermedio
    if (interimTranscript && interimTranscript !== vr.lastInterim) {
      let visibleText = vr.committed ? overlapAppend(vr.committed, interimTranscript) : interimTranscript;
      input.value = visibleText;
      vr.lastInterim = interimTranscript;
    }
    
    resetSilenceTimer();
  };

  recognition.onerror = (e) => { 
    console.log("Error en reconocimiento de voz:", e.error);
    clearTimeout(vr.timer); 
    vr.running = false;
    talk.textContent = 'üé§';
  };
  
  recognition.onend = () => { 
    clearTimeout(vr.timer); 
    vr.running = false;
    talk.textContent = 'üé§';
    
    // Si hay texto en el input, enviarlo autom√°ticamente
    if (input.value.trim()) {
      setTimeout(() => {
        send.click();
      }, 300);
    }
  };
}

if (talk && recognition){
  talk.addEventListener('click', ()=>{
    if (vr.running){
      try { recognition.stop(); } catch {}
      vr.running = false;
      talk.textContent = 'üé§';
    } else {
      try { 
        recognition.start(); 
        talk.textContent = 'üî¥';
      } catch (e) {
        console.error("Error al iniciar reconocimiento:", e);
        botMsg("‚ùå Error al acceder al micr√≥fono. Aseg√∫rate de permitir el acceso.");
      }
    }
  });
}
// ================== fin bot.js ==================
    </script>
</body>
</html>